<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Trend Counters with Individual Totals</title>
  <style>
    .input-number {
      font-size: 40px;
      text-align: center;
    }
    .mounter-container {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      justify-content: center;
    }
    .mounter {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      padding: 50px;
      border-radius: 5px;
      text-align: center;
      width: 100px;
    }
    button {
      touch-action: manipulation;
      font-size: 80px;
      text-align: center;
      height: 70px;
      width: 70px;
    }
    .reset-button {
      font-size: 20px;
      margin-left: 10px;
    }
    .total {
      font-size: 40px;
      text-align: center;
    }
    #overall-total {
      font-size: 80px;
      text-align: center;
    }
    .select-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .select-container select {
      font-size: 20px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      width: 150px;
    }
    .selected-items {
      text-align: center;
      font-size: 20px;
      margin-top: 10px;
    }
    #all-counters {
      display: none; /* Default olarak gizle */
    }
    #download-btn {
      font-size: 30px;
      padding: 15px 50px; /* Yatayda ve dikeyde padding artırıldı */
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #download-btn:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

  <center>
    <div class="select-container">
      <div>
        <label for="select1">Select 1</label>
        <select id="select1" onchange="displaySelectedItems()">
          <option value="">Select...</option>
          <option value="Option 1">Option 1</option>
          <option value="Option 2">Option 2</option>
          <option value="Option 3">Option 3</option>
          <!-- Add more options here as needed -->
        </select>
        <div id="selected1" class="selected-items"></div>
      </div>
      <div>
        <label for="select2">Select 2</label>
        <select id="select2" onchange="displaySelectedItems()">
          <option value="">Select...</option>
          <option value="Option A">Option A</option>
          <option value="Option B">Option B</option>
          <option value="Option C">Option C</option>
          <!-- Add more options here as needed -->
        </select>
        <div id="selected2" class="selected-items"></div>
      </div>
    </div>

    <div id="all-counters"></div> <!-- Dinamik sayaç setleri burada oluşturulacak -->

    <div>
      <h1>Overall Total</h1>
      <div id="overall-total">0</div>
    </div>

    <button id="download-btn" onclick="downloadExcel()">İndir</button>
  </center>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
  <script>
    const numSets = 5; // Kaç tane sayaç seti oluşturulacağı
    const allCounters = document.getElementById('all-counters');
    let debounceTimer;

    // Tarayıcıda depolanan sayaç ve girdi değerlerini yükle
    function loadState() {
      const select1 = document.getElementById('select1').value;
      const select2 = document.getElementById('select2').value;
      if (!select1 || !select2) return;

      allCounters.innerHTML = '';

      for (let i = 1; i <= numSets; i++) {
        const trendadiId = `trendadi_${select1}_${select2}_${i}`;
        const trendId = `trend-value_${select1}_${select2}_${i}`;
        const keyId = `key-value_${select1}_${select2}_${i}`;
        const timeId = `time-value_${select1}_${select2}_${i}`;
        const nosId = `nos-value_${select1}_${select2}_${i}`;
        const totalId = `set-total_${select1}_${select2}_${i}`;

        const savedTrendadi = localStorage.getItem(trendadiId) || `TREND&KUMAŞ ${i}`;
        const savedTrend = parseInt(localStorage.getItem(trendId), 10) || 0;
        const savedKey = parseInt(localStorage.getItem(keyId), 10) || 0;
        const savedTime = parseInt(localStorage.getItem(timeId), 10) || 0;
        const savedNos = parseInt(localStorage.getItem(nosId), 10) || 0;
        const setTotal = savedTrend + savedKey + savedTime + savedNos;

        // Sayaç seti HTML'sini oluştur
        const counterSet = `
          <input type="text" id="${trendadiId}" name="${trendadiId}" value="${savedTrendadi}" class="input-number" oninput="saveInput('${trendadiId}', this.value)"><br>
          <div class="mounter-container">
            <div class="mounter">
              <h1>TREND</h1>
              <div id="${trendId}">${savedTrend}</div>
              <button onclick="changeValue('${trendId}', -1, '${totalId}', event)">-</button>
              <button onclick="changeValue('${trendId}', 1, '${totalId}', event)">+</button>
            </div>

            <div class="mounter">
              <h1>KEY</h1>
              <div id="${keyId}">${savedKey}</div>
              <button onclick="changeValue('${keyId}', -1, '${totalId}', event)">-</button>
              <button onclick="changeValue('${keyId}', 1, '${totalId}', event)">+</button>
            </div>

            <div class="mounter">
              <h1>TIME</h1>
              <div id="${timeId}">${savedTime}</div>
              <button onclick="changeValue('${timeId}', -1, '${totalId}', event)">-</button>
              <button onclick="changeValue('${timeId}', 1, '${totalId}', event)">+</button>
            </div>

            <div class="mounter">
              <h1>NOS</h1>
              <div id="${nosId}">${savedNos}</div>
              <button onclick="changeValue('${nosId}', -1, '${totalId}', event)">-</button>
              <button onclick="changeValue('${nosId}', 1, '${totalId}', event)">+</button>
            </div>
          </div>
          <h2>Set Total: <span id="${totalId}" class="total">${setTotal}</span>
          <button class="reset-button" onclick="resetSet(${i}, '${totalId}', '${select1}', '${select2}')">Reset</button></h2><br>
        `;

        // Tüm seti sayfaya ekle
        allCounters.innerHTML += counterSet;
      }

      updateOverallTotal(); // Sayfa yüklenirken genel toplam güncellenir
    }

    // Sayaç değerini değiştir ve ilgili set toplamını güncelle
    function changeValue(id, delta, totalId, event) {
      event.preventDefault(); // Zoom olayını engelle

      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      debounceTimer = setTimeout(() => {
        let element = document.getElementById(id);
        let currentValue = parseInt(element.innerText, 10);
        let newValue = currentValue + delta;

        if (newValue < 0) {
          newValue = 0;
        }

        element.innerText = newValue;
        localStorage.setItem(id, newValue); // Değeri yerel depoda sakla
        updateSetTotal(totalId);
      }, 50); // 50 ms gecikme ile debouncing
    }

    // Girdi alanındaki değeri yerel depoda sakla
    function saveInput(inputId, value) {
      localStorage.setItem(inputId, value);
    }

    // Belirtilen sayaç setinin toplamını güncelle
    function updateSetTotal(totalId) {
      const select1 = document.getElementById('select1').value;
      const select2 = document.getElementById('select2').value;
      const prefix = `_${select1}_${select2}_`;
      const index = totalId.split('_').pop();
      const trend = parseInt(document.getElementById(`trend-value${prefix}${index}`).innerText, 10);
      const key = parseInt(document.getElementById(`key-value${prefix}${index}`).innerText, 10);
      const time = parseInt(document.getElementById(`time-value${prefix}${index}`).innerText, 10);
      const nos = parseInt(document.getElementById(`nos-value${prefix}${index}`).innerText, 10);

      const setTotal = trend + key + time + nos;
      document.getElementById(totalId).innerText = setTotal;

      updateOverallTotal();
    }

    // Bir setin tüm sayaçlarını sıfırla
    function resetSet(index, totalId, select1, select2) {
      const prefix = `_${select1}_${select2}_`;
      const trendadiId = `trendadi${prefix}${index}`;
      const trendId = `trend-value${prefix}${index}`;
      const keyId = `key-value${prefix}${index}`;
      const timeId = `time-value${prefix}${index}`;
      const nosId = `nos-value${prefix}${index}`;

      document.getElementById(trendadiId).value = `TREND&KUMAŞ ${index}`;
      document.getElementById(trendId).innerText = 0;
      document.getElementById(keyId).innerText = 0;
      document.getElementById(timeId).innerText = 0;
      document.getElementById(nosId).innerText = 0;

      localStorage.setItem(trendadiId, `TREND&KUMAŞ ${index}`);
      localStorage.setItem(trendId, 0);
      localStorage.setItem(keyId, 0);
      localStorage.setItem(timeId, 0);
      localStorage.setItem(nosId, 0);

      document.getElementById(totalId).innerText = 0;
      updateOverallTotal();
    }

    // Tüm sayaç setlerinin toplamını hesapla
    function updateOverallTotal() {
      const select1 = document.getElementById('select1').value;
      const select2 = document.getElementById('select2').value;
      let overallTotal = 0;

      for (let i = 1; i <= numSets; i++) {
        const prefix = `_${select1}_${select2}_`;
        const trend = parseInt(document.getElementById(`trend-value${prefix}${i}`).innerText, 10);
        const key = parseInt(document.getElementById(`key-value${prefix}${i}`).innerText, 10);
        const time = parseInt(document.getElementById(`time-value${prefix}${i}`).innerText, 10);
        const nos = parseInt(document.getElementById(`nos-value${prefix}${i}`).innerText, 10);

        overallTotal += trend + key + time + nos;
      }

      document.getElementById('overall-total').innerText = overallTotal;
    }

    // Seçilen öğeleri göster
    function displaySelectedItems() {
      const select1 = document.getElementById('select1').value;
      const select2 = document.getElementById('select2').value;

      if (select1 && select2) {
        document.getElementById('selected1').innerText = `Selected: ${select1}`;
        document.getElementById('selected2').innerText = `Selected: ${select2}`;
        document.getElementById('all-counters').style.display = 'block';
        loadState();
      } else {
        document.getElementById('selected1').innerText = '';
        document.getElementById('selected2').innerText = '';
        document.getElementById('all-counters').style.display = 'none';
      }
    }

    // Excel dosyasını indir
    function downloadExcel() {
      const select1 = document.getElementById('select1').value;
      const select2 = document.getElementById('select2').value;
      const data = [];

      for (let i = 1; i <= numSets; i++) {
        const prefix = `_${select1}_${select2}_`;
        const trendadi = document.getElementById(`trendadi${prefix}${i}`).value;
        const trend = parseInt(document.getElementById(`trend-value${prefix}${i}`).innerText, 10);
        const key = parseInt(document.getElementById(`key-value${prefix}${i}`).innerText, 10);
        const time = parseInt(document.getElementById(`time-value${prefix}${i}`).innerText, 10);
        const nos = parseInt(document.getElementById(`nos-value${prefix}${i}`).innerText, 10);
        const zaman = new Date().toLocaleString();

        data.push({ 'Select 1': select1, 'Select 2': select2, 'TREND&KUMAŞ': trendadi, 'TREND': trend, 'KEY': key, 'TIME': time, 'NOS': nos, 'ZAMAN': zaman });
      }

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

      XLSX.writeFile(wb, "data.xlsx");
    }

    window.onload = displaySelectedItems;
  </script>

</body>
</html>
